apiVersion: apps/v1
kind: Deployment
metadata:
  name: workerpodautoscaler
  labels:
    app: workerpodautoscaler
spec:
  replicas: 1
  selector:
    matchLabels:
      app: workerpodautoscaler
  template:
    metadata:
      labels:
        app: workerpodautoscaler
    spec:
      serviceAccountName: workerpodautoscaler
      tolerations:
      - effect: NoExecute
        operator: Exists
      - effect: NoSchedule
        operator: Exists
      containers:
      - name: wpa
        env:
        {{- if .Values.awsAccessKeyId -}}
        - name: AWS_ACCESS_KEY_ID
          value: {{ .Values.awsAccessKeyId }}
        {{- end }}
        {{- if .Values.awsSecretAccessKey -}}
        - name: AWS_SECRET_ACCESS_KEY
          value: {{ .Values.awsSecretAccessKey }}
        {{- end }}
        image: public.ecr.aws/practo/workerpodautoscaler:v{{ default .Chart.AppVersion }}
        imagePullPolicy: Always
        command:
        - /workerpodautoscaler
        - run
        - --resync-period=20
        - --wpa-threads=10
        - --aws-regions={{ include "worker-pod-autoscaler.awsRegions" . }}
        - --sqs-short-poll-interval=20
        - --sqs-long-poll-interval=20
        - --k8s-api-qps=5.0
        - --k8s-api-burst=10
        - --wpa-default-max-disruption=100%
        - --queue-services=sqs,beanstalkd
        - -v=2
        resources:
          limits:
            cpu: 100m
            memory: 100Mi
          requests:
            cpu: 10m
            memory: 20Mi
