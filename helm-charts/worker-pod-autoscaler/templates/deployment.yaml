apiVersion: apps/v1
kind: Deployment
metadata:
  name: workerpodautoscaler
  labels:
    {{- include "worker-pod-autoscaler.labels" . | nindent 4 }}
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "worker-pod-autoscaler.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "worker-pod-autoscaler.labels" . | nindent 8 }}
    spec:
      serviceAccountName: {{ .Values.serviceAccount.name }}
      tolerations:
      - effect: NoExecute
        operator: Exists
      - effect: NoSchedule
        operator: Exists
      containers:
      - name: wpa
        env:
        {{- if .Values.awsAccessKeyId -}}
        - name: AWS_ACCESS_KEY_ID
          value: {{ .Values.awsAccessKeyId }}
        {{- end }}
        {{- if .Values.awsSecretAccessKey -}}
        - name: AWS_SECRET_ACCESS_KEY
          value: {{ .Values.awsSecretAccessKey }}
        {{- end }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default (printf "v%s" .Chart.AppVersion) }}"
        imagePullPolicy: IfNotPresent
        command:
        - /workerpodautoscaler
        - run
        - --resync-period=20
        - --wpa-threads=10
        - --aws-regions={{ include "worker-pod-autoscaler.awsRegions" . }}
        - --sqs-short-poll-interval=20
        - --sqs-long-poll-interval=20
        - --k8s-api-qps=5.0
        - --k8s-api-burst=10
        - --wpa-default-max-disruption=100%
        - --queue-services={{ include "worker-pod-autoscaler.queueServices" . }}
        - -v={{ .Values.logLevel }}
        resources:
          limits:
            cpu: 100m
            memory: 100Mi
          requests:
            cpu: 10m
            memory: 20Mi
